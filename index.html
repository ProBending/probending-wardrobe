<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Probending Wardrobe</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <script src="https://unpkg.com/skinview3d/bundles/skinview3d.bundle.js"></script>

  <style>
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: radial-gradient(circle at top, #1b2735, #090a0f);
      color: #f9fafb;
    }

    .app {
      width: 100%;
      max-width: 980px;
      background: rgba(15, 23, 42, 0.96);
      border-radius: 18px;
      padding: 22px 26px 26px;
      display: grid;
      grid-template-columns: minmax(0, 1.4fr) minmax(0, 1fr);
      gap: 20px;
    }

    .card-section {
      background: rgba(15, 23, 42, 0.85);
      border-radius: 14px;
      padding: 14px;
      border: 1px solid rgba(148, 163, 184, 0.25);
    }

    #skin3d {
      width: 100%;
      height: 360px;
      background: transparent;
      display: block;
    }

    .viewer-bg {
      border-radius: 14px;
      padding: 10px;
      background-size: cover;
      background-position: center;
      border: 1px solid rgba(148,163,184,0.5);
    }
  </style>
</head>

<body>
  <main class="app">

    <!-- LEFT SIDE OMITTED FOR BREVITY, YOU KEEP YOUR EXISTING LEFT PANEL -->

    <!-- RIGHT SIDE PREVIEW PANEL -->
    <section class="card-section">
      <div class="section-title">3 Â· Preview & Download</div>

      <div class="viewer-bg">
        <canvas id="skin3d"></canvas>
      </div>

      <!-- ðŸ”¥ THIS WAS MISSING â€” RE-ADDED -->
      <canvas id="skinCanvas" width="64" height="64" style="display:none;"></canvas>

      <div id="statusText" class="status">Load a skin to get started.</div>

      <button id="downloadBtn" disabled>Download Combined Skin</button>
    </section>

  </main>

  <!-- ðŸ”¥ YOUR SCRIPT BLOCK (unchanged except for working v5) -->
  <script>
  document.addEventListener("DOMContentLoaded", () => {
    console.log("Probending Wardrobe Script â€“ SAFE v5 Loaded");

    const canvas = document.getElementById("skinCanvas");
    const ctx = canvas.getContext("2d");

    const skin3dCanvas = document.getElementById("skin3d");
    const statusText = document.getElementById("statusText");
    const downloadBtn = document.getElementById("downloadBtn");

    const skinFileInput = document.getElementById("skinFile");
    const usernameInput = document.getElementById("usernameInput");
    const loadUsernameBtn = document.getElementById("loadUsernameBtn");

    const outfitButtons = Array.from(document.querySelectorAll(".outfit-btn"));
    const modelButtons = Array.from(document.querySelectorAll(".pill-btn"));

    let baseSkinImg = null;
    let outfitImg = null;
    let currentModel = "default";

    function setStatus(msg) { statusText.textContent = msg; }

    const viewer = new skinview3d.SkinViewer({
      canvas: skin3dCanvas,
      width: 300,
      height: 360,
      zoom: 0.9
    });

    viewer.autoRotate = true;
    viewer.autoRotateSpeed = 0.6;

    function update3DPreview() {
      if (!baseSkinImg) return;

      let url;
      try { url = canvas.toDataURL(); }
      catch (e) {
        setStatus("Security error â€“ use GitHub Pages URL.");
        return;
      }

      const img = new Image();
      img.onload = () => viewer.loadSkin(img.src, { model: currentModel });
      img.src = url;
    }

    function clearOuterLayers() {
      // Upper outer layers
      ctx.clearRect(16,36,24,12);
      ctx.clearRect(40,36,8,12);
      ctx.clearRect(48,36,8,12);
      ctx.clearRect(0,36,8,12);
      ctx.clearRect(8,36,8,12);

      // Lower outer layers
      ctx.clearRect(16,52,24,12);
      ctx.clearRect(40,52,8,12);
      ctx.clearRect(48,52,8,12);
      ctx.clearRect(0,52,8,12);
      ctx.clearRect(8,52,8,12);
    }

    function renderCanvas() {
      if (!baseSkinImg) {
        ctx.clearRect(0,0,canvas.width,canvas.height);
        setStatus("Load a skin to begin.");
        downloadBtn.disabled = true;
        return;
      }

      canvas.width = baseSkinImg.width;
      canvas.height = baseSkinImg.height;

      ctx.clearRect(0,0,canvas.width,canvas.height);
      ctx.drawImage(baseSkinImg,0,0);

      clearOuterLayers();

      if (outfitImg) ctx.drawImage(outfitImg,0,0);

      downloadBtn.disabled = false;
      update3DPreview();
    }

    // File upload
    skinFileInput?.addEventListener("change", e => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = ev => {
        const img = new Image();
        img.onload = () => { baseSkinImg = img; renderCanvas(); };
        img.src = ev.target.result;
      };
      reader.readAsDataURL(file);
    });

    // Username
    loadUsernameBtn?.addEventListener("click", () => {
      const name = usernameInput.value.trim();
      if (!name) return;

      const img = new Image();
      img.crossOrigin = "anonymous";
      img.onload = () => { baseSkinImg = img; renderCanvas(); };
      img.src = "https://minotar.net/skin/" + encodeURIComponent(name);
    });

    // Outfits
    outfitButtons.forEach(btn => {
      btn.addEventListener("click", () => {
        outfitButtons.forEach(b => b.classList.remove("active"));
        btn.classList.add("active");

        if (!btn.dataset.outfit) {
          outfitImg = null;
          renderCanvas();
          return;
        }

        const img = new Image();
        img.onload = () => { outfitImg = img; renderCanvas(); };
        img.src = btn.dataset.outfit;
      });
    });

    // Model toggle
    modelButtons.forEach(btn => {
      btn.addEventListener("click", () => {
        modelButtons.forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        currentModel = btn.dataset.model;
        update3DPreview();
      });
    });

    downloadBtn.addEventListener("click", () => {
      let url;
      try { url = canvas.toDataURL("image/png"); }
      catch (e) { setStatus("Security error."); return; }

      const a = document.createElement("a");
      a.href = url;
      a.download = "probending_skin.png";
      a.click();
    });

  });
  </script>

</body>
</html>
