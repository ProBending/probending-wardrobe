<script>
document.addEventListener("DOMContentLoaded", () => {
  console.log("Probending Wardrobe â€“ Final Base Second-Layer Hide Build Loaded");

  const canvas = document.getElementById("skinCanvas");
  const ctx = canvas.getContext("2d");

  const statusText = document.getElementById("statusText");
  const downloadBtn = document.getElementById("downloadBtn");

  const outfitButtons = [...document.querySelectorAll(".outfit-btn")];
  const modelButtons  = [...document.querySelectorAll(".toggle-btn")];

  const skin3dCanvas = document.getElementById("skin3d");

  let baseSkinImg = null;
  let outfitImg = null;
  let currentModel = "default";

  // 3D VIEWER
  const viewer = new skinview3d.SkinViewer({
    canvas: skin3dCanvas,
    width: 300,
    height: 380,
    zoom: 0.9
  });
  viewer.autoRotate = true;

  /**
   * Wipe ONLY the base skin's second layer for:
   * - Torso
   * - Arms
   * - Legs/Feet
   *
   * Coordinates are for 64x64 skins:
   *  - Torso outer: 16,32 size 24x16
   *  - Right arm outer: 40,32 size 16x16
   *  - Left arm outer: 32,48 size 16x16
   *  - Right leg outer: 0,32 size 16x16
   *  - Left leg outer: 16,48 size 16x16
   */
  function clearOuterLayer() {
    // Torso outer layer
    ctx.clearRect(16, 32, 24, 16);

    // Arms outer layer
    ctx.clearRect(40, 32, 16, 16); // Right arm
    ctx.clearRect(32, 48, 16, 16); // Left arm

    // Legs/feet outer layer
    ctx.clearRect(0, 32, 16, 16);  // Right leg
    ctx.clearRect(16, 48, 16, 16); // Left leg
  }

  // Update 3D viewer using the current canvas
  function update3D() {
    if (!baseSkinImg) return;
    viewer.loadSkin(canvas.toDataURL(), { model: currentModel });
  }

  // Rebuild the hidden canvas: base -> wipe layer -> outfit -> viewer
  function renderCanvas() {
    if (!baseSkinImg) return;

    canvas.width = 64;
    canvas.height = 64;

    // Draw base skin
    ctx.clearRect(0, 0, 64, 64);
    ctx.drawImage(baseSkinImg, 0, 0);

    // Remove the base skin's torso/arms/legs second layer
    clearOuterLayer();

    // Draw outfit on top
    if (outfitImg) {
      ctx.drawImage(outfitImg, 0, 0);
    }

    // Refresh viewer + enable download
    update3D();
    downloadBtn.disabled = false;
    statusText.textContent = "Outfit applied. You can download your probending skin.";
  }

  /* LOADERS */

  // Upload skin file
  document.getElementById("skinFile").addEventListener("change", (e) => {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (ev) => {
      const img = new Image();
      img.onload = () => {
        baseSkinImg = img;
        renderCanvas();
      };
      img.src = ev.target.result;
    };
    reader.readAsDataURL(file);
  });

  // Load skin by username
  document.getElementById("loadUsernameBtn").addEventListener("click", () => {
    const name = document.getElementById("usernameInput").value.trim();
    if (!name) return;

    const img = new Image();
    img.crossOrigin = "anonymous";
    img.onload = () => {
      baseSkinImg = img;
      renderCanvas();
    };
    img.src = "https://minotar.net/skin/" + encodeURIComponent(name);
  });

  // Outfit buttons
  outfitButtons.forEach(btn => {
    btn.addEventListener("click", () => {
      outfitButtons.forEach(b => b.classList.remove("active"));
      btn.classList.add("active");

      const img = new Image();
      img.onload = () => {
        outfitImg = img;
        renderCanvas();
      };
      img.src = btn.dataset.outfit;
    });
  });

  // Model type toggle (Steve / Slim)
  modelButtons.forEach(btn => {
    btn.addEventListener("click", () => {
      modelButtons.forEach(b => b.classList.remove("active"));
      btn.classList.add("active");

      currentModel = btn.dataset.model;
      update3D();
    });
  });

  // DOWNLOAD
  downloadBtn.addEventListener("click", () => {
    const a = document.createElement("a");
    a.href = canvas.toDataURL("image/png");
    a.download = "probending_skin.png";
    a.click();
  });

});
</script>
