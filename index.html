<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Probending Wardrobe</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- 3D Skin Viewer -->
  <script src="https://unpkg.com/skinview3d/bundles/skinview3d.bundle.js"></script>

  <style>
    body {
      margin: 0;
      background: #0b0e1a;
      font-family: system-ui, sans-serif;
      color: #eee;
      display: flex;
      justify-content: center;
      padding: 20px;
    }

    .app {
      width: 100%;
      max-width: 1000px;
      display: grid;
      grid-template-columns: 1.1fr 1fr;
      gap: 20px;
    }

    .card {
      background: #151a28;
      padding: 16px;
      border-radius: 10px;
      border: 1px solid #2a3147;
    }

    h2 { margin-top: 0; }

    label {
      display: block;
      margin: 6px 0 2px;
    }

    input[type="file"],
    input[type="text"] {
      width: 100%;
      padding: 6px;
      border-radius: 6px;
      border: 1px solid #333a50;
      background: #0e1320;
      color: white;
    }

    button {
      padding: 8px 12px;
      background: #3b82f6;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      color: white;
      margin-top: 10px;
    }

    .outfit-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
      margin-top: 10px;
    }

    .outfit-btn {
      background: #22283a;
      border: 1px solid #3b4055;
      padding: 8px;
      border-radius: 6px;
      color: white;
      cursor: pointer;
      text-align: center;
    }
    .outfit-btn.active {
      background: #16a34a;
      border-color: #16a34a;
    }

    .viewer-bg {
      background-image: url("assets/probending_bg.png");
      background-size: cover;
      background-position: center;
      padding: 10px;
      border-radius: 10px;
      border: 1px solid #2a3147;
    }

    #skin3d {
      width: 100%;
      height: 380px;
    }

    .toggle-row {
      margin-top: 12px;
      display: flex;
      gap: 10px;
    }

    .toggle-btn {
      flex: 1;
      background: #22283a;
      border: 1px solid #3b4055;
      padding: 8px;
      text-align: center;
      cursor: pointer;
      border-radius: 6px;
    }
    .toggle-btn.active {
      background: #16a34a;
      color: white;
      border-color: #16a34a;
    }

    #statusText { margin-top: 12px; color: #9ca3af; }
  </style>
</head>

<body>

<div class="app">

  <!-- LEFT PANEL -->
  <div class="card">
    <h2>Load Skin</h2>

    <label>Upload Skin (.png)</label>
    <input type="file" id="skinFile" accept="image/png" />

    <label style="margin-top:12px;">Or Load by Username</label>
    <input type="text" id="usernameInput" placeholder="Minecraft username" />
    <button id="loadUsernameBtn">Load Username Skin</button>

    <h2 style="margin-top:20px;">Choose Probending Outfit</h2>
    <div class="outfit-grid">
      <div class="outfit-btn" data-outfit="outfits/red_team.png">Red</div>
      <div class="outfit-btn" data-outfit="outfits/blue_team.png">Blue</div>
      <div class="outfit-btn" data-outfit="outfits/red_slim.png">Red (Slim)</div>
      <div class="outfit-btn" data-outfit="outfits/blue_slim.png">Blue (Slim)</div>
    </div>

    <h2 style="margin-top:20px;">Model Type</h2>
    <div class="toggle-row">
      <div class="toggle-btn active" data-model="default">Steve</div>
      <div class="toggle-btn" data-model="slim">Slim (Alex)</div>
    </div>
  </div>

  <!-- RIGHT PANEL -->
  <div class="card">
    <h2>Preview & Download</h2>

    <div class="viewer-bg">
      <canvas id="skin3d"></canvas>
    </div>

    <!-- Hidden canvas for compositing -->
    <canvas id="skinCanvas" width="64" height="64" style="display:none;"></canvas>

    <div id="statusText">Load a skin to begin.</div>
    <button id="downloadBtn" disabled>Download Skin</button>
  </div>

</div>


<script>
document.addEventListener("DOMContentLoaded", () => {
  console.log("Probending Wardrobe â€“ UV-Fixed Build Loaded");

  const canvas = document.getElementById("skinCanvas");
  const ctx = canvas.getContext("2d");

  const statusText = document.getElementById("statusText");
  const downloadBtn = document.getElementById("downloadBtn");

  const outfitButtons = [...document.querySelectorAll(".outfit-btn")];
  const modelButtons = [...document.querySelectorAll(".toggle-btn")];

  const skin3dCanvas = document.getElementById("skin3d");

  let baseSkinImg = null;
  let outfitImg = null;
  let currentModel = "default";

  function setStatus(msg) {
    statusText.textContent = msg;
  }

  /* -------------------------------
     3D VIEWER
  --------------------------------*/
  const viewer = new skinview3d.SkinViewer({
    canvas: skin3dCanvas,
    width: 300,
    height: 380,
    zoom: 0.9
  });
  viewer.autoRotate = true;
  viewer.autoRotateSpeed = 0.6;


  /* -------------------------------
     LOAD 3D MODEL
  --------------------------------*/
  function update3D() {
    if (!baseSkinImg) return;
    viewer.loadSkin(canvas.toDataURL(), { model: currentModel });
  }


  /* -------------------------------------------------------
     TRUE UV-SAFE OUTER-LAYER REMOVAL
  ------------------------------------------------------- */
  function clearOuterLayers() {
    // Create a single transparent pixel to stamp UV regions with
    const px = document.createElement("canvas");
    px.width = 1;
    px.height = 1;
    const pctx = px.getContext("2d");
    pctx.clearRect(0,0,1,1);

    const regions = [
      [16,36,24,12],  // torso layer 2
      [40,36,8,12],   // right arm layer 2
      [48,36,8,12],   // left arm layer 2
      [0,36,8,12],    // right leg layer 2
      [8,36,8,12],    // left leg layer 2
      [16,52,24,12],
      [40,52,8,12],
      [48,52,8,12],
      [0,52,8,12],
      [8,52,8,12]
    ];

    // Draw transparent pixel on every UV so geometry is satisfied
    regions.forEach(([x,y,w,h]) => {
      for (let ix = 0; ix < w; ix++) {
        for (let iy = 0; iy < h; iy++) {
          ctx.drawImage(px, x + ix, y + iy);
        }
      }
    });
  }


  /* -------------------------------
     RENDER FINAL SKIN
  --------------------------------*/
  function renderCanvas() {
    if (!baseSkinImg) return;

    canvas.width = baseSkinImg.width;
    canvas.height = baseSkinImg.height;

    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.drawImage(baseSkinImg,0,0);

    clearOuterLayers();

    if (outfitImg) ctx.drawImage(outfitImg,0,0);

    update3D();
    downloadBtn.disabled = false;
    setStatus("Skin ready. Download when satisfied.");
  }


  /* LOAD FROM UPLOAD */
  document.getElementById("skinFile").addEventListener("change", e => {
    const file = e.target.files[0];
    const reader = new FileReader();
    reader.onload = ev => {
      const img = new Image();
      img.onload = () => { baseSkinImg = img; renderCanvas(); };
      img.src = ev.target.result;
    };
    reader.readAsDataURL(file);
  });


  /* LOAD FROM USERNAME */
  document.getElementById("loadUsernameBtn").addEventListener("click", () => {
    const name = document.getElementById("usernameInput").value.trim();
    if (!name) return;

    const img = new Image();
    img.crossOrigin = "anonymous";
    img.onload = () => { baseSkinImg = img; renderCanvas(); };
    img.src = "https://minotar.net/skin/" + encodeURIComponent(name);
  });


  /* OUTFITS */
  outfitButtons.forEach(btn => {
    btn.addEventListener("click", () => {
      outfitButtons.forEach(b => b.classList.remove("active"));
      btn.classList.add("active");

      const img = new Image();
      img.onload = () => { outfitImg = img; renderCanvas(); };
      img.src = btn.dataset.outfit;
    });
  });


  /* MODEL TOGGLE */
  modelButtons.forEach(btn => {
    btn.addEventListener("click", () => {
      modelButtons.forEach(b => b.classList.remove("active"));
      btn.classList.add("active");

      currentModel = btn.dataset.model;
      update3D();
    });
  });


  /* DOWNLOAD */
  downloadBtn.addEventListener("click", () => {
    const a = document.createElement("a");
    a.href = canvas.toDataURL("image/png");
    a.download = "probending_skin.png";
    a.click();
  });

});
</script>

</body>
</html>
