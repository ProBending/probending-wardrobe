<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Probending Wardrobe</title>
  <!-- SkinView3D CDN fallback chain -->
<script src="https://cdn.jsdelivr.net/npm/skinview3d@3.0.0/bundles/skinview3d.bundle.js"></script>
<script src="https://unpkg.com/skinview3d@3.0.0/dist/skinview3d.bundle.js"></script>
<script src="https://rawcdn.githack.com/bs-community/skinview3d/3.0.0/bundles/skinview3d.bundle.js"></script>

<style>
  body { font-family: Arial; background:#111; color:white; margin:0; padding:20px; }
  .container { max-width:900px; margin:auto; }
  .row { display:flex; gap:20px; margin-top:20px; }
  .column { flex:1; }
  button, .outfit-btn {
    padding:10px 15px; margin:5px 0; cursor:pointer; background:#333; border:none; color:white;
  }
  .outfit-btn.active, .toggle-btn.active { background:#008cff; }
</style>

</head>

<body>
<div class="container">
  <h1>Probending Wardrobe</h1>

  <!-- LOAD SKIN -->
  <div>
    <input type="file" id="skinFile" />
    <input type="text" id="usernameInput" placeholder="Enter Minecraft username" />
    <button id="loadUsernameBtn">Load Username Skin</button>
  </div>

  <!-- MODEL TOGGLE -->
  <div>
    <button class="toggle-btn active" data-model="default">Steve Model</button>
    <button class="toggle-btn" data-model="slim">Slim Model</button>
  </div>

  <!-- OUTFITS -->
  <h3>Choose Outfit</h3>
  <div>
    <button class="outfit-btn" data-outfit="outfits/red_team.png">Red Team</button>
    <button class="outfit-btn" data-outfit="outfits/blue_team.png">Blue Team</button>
    <button class="outfit-btn" data-outfit="outfits/red_slim.png">Red Slim</button>
    <button class="outfit-btn" data-outfit="outfits/blue_slim.png">Blue Slim</button>
  </div>

  <!-- VIEWER -->
  <div class="row">
    <div class="column">
      <canvas id="skin3d" width="300" height="380"></canvas>

      <!-- REQUIRED HIDDEN CANVAS -->
      <canvas id="skinCanvas" width="64" height="64" style="display:none;"></canvas>

      <p id="statusText">Load a skin to begin.</p>
      <button id="downloadBtn" disabled>Download Skin</button>
    </div>
  </div>
</div>

<!-- FULL WORKING SCRIPT -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  console.log("Probending Wardrobe – Base Outer-Layer Wipe Build Loaded");

  const canvas = document.getElementById("skinCanvas");
  const ctx = canvas.getContext("2d");

  const statusText  = document.getElementById("statusText");
  const downloadBtn = document.getElementById("downloadBtn");

  const outfitButtons = Array.from(document.querySelectorAll(".outfit-btn"));
  const modelButtons  = Array.from(document.querySelectorAll(".toggle-btn"));
  const skin3dCanvas = document.getElementById("skin3d");

  let baseSkinImg  = null;
  let outfitImg    = null;
  let currentModel = "default";

  // --- 3D VIEWER ---
  const viewer = new skinview3d.SkinViewer({
    canvas: skin3dCanvas,
    width: 300,
    height: 380,
    zoom: 0.9
  });
  viewer.autoRotate = true;

  // --- REMOVE torso / legs / arms (base + outer layer) ---
function clearOuterLayer() {
  ctx.clearRect(16, 16, 24, 32);       // body
  ctx.clearRect(40, 18, 16, 14);       // right arm
  ctx.clearRect(32, 50, 16, 14);       // left arm
  ctx.clearRect(40, 32, 16, 16);       // outer R arm
  ctx.clearRect(48, 48, 16, 16);       // outer L arm
  ctx.clearRect(0, 16, 16, 32);        // legs
  ctx.clearRect(16, 48, 16, 16);
  ctx.clearRect(0, 48, 16, 16);
}

  // ⭐ --- DEFAULT OUTFIT AUTO-APPLY (now async-correct) ---
  function applyDefaultOutfit(callback) {
    const defaultOutfit = "outfits/red_team.png";

    const img = new Image();
    img.onload = () => {
      outfitImg = img;

      // highlight active button
      outfitButtons.forEach(b => {
        b.classList.toggle("active", b.dataset.outfit === defaultOutfit);
      });

      if (callback) callback(); // ⬅ ensures render happens AFTER outfit loads
    };
    img.src = defaultOutfit;
  }

  // --- RENDER ---
  function renderCanvas() {
    if (!baseSkinImg) return;

    canvas.width = 64;
    canvas.height = 64;

    ctx.clearRect(0, 0, 64, 64);
    ctx.drawImage(baseSkinImg, 0, 0);
    clearOuterLayer();
    if (outfitImg) ctx.drawImage(outfitImg, 0, 0);

    viewer.loadSkin(canvas.toDataURL("image/png"), { model: currentModel });

    downloadBtn.disabled = false;
    statusText.textContent = "Outfit applied — ready to download!";
  }

  // --- FILE UPLOAD ---
  document.getElementById("skinFile").addEventListener("change", (e) => {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (ev) => {
      const img = new Image();
      img.onload = () => {
        baseSkinImg = img;
        applyDefaultOutfit(renderCanvas);   // ⭐ FIXED TIMING
      };
      img.src = ev.target.result;
    };
    reader.readAsDataURL(file);
  });

  // --- LOAD USERNAME ---
  document.getElementById("loadUsernameBtn").addEventListener("click", () => {
    const name = document.getElementById("usernameInput").value.trim();
    if (!name) return;

    const img = new Image();
    img.crossOrigin = "anonymous";
    img.onload = () => {
      baseSkinImg = img;
      applyDefaultOutfit(renderCanvas);   // ⭐ FIXED TIMING
    };
    img.src = "https://minotar.net/skin/" + encodeURIComponent(name);
  });

  // --- OUTFITS ---
  outfitButtons.forEach((btn) => {
    btn.addEventListener("click", () => {
      outfitButtons.forEach(b => b.classList.remove("active"));
      btn.classList.add("active");

      const img = new Image();
      img.onload = () => { outfitImg = img; renderCanvas(); };
      img.src = btn.dataset.outfit;
    });
  });

  // --- MODEL SWITCH ---
  modelButtons.forEach((btn) => {
    btn.addEventListener("click", () => {
      modelButtons.forEach(b => b.classList.remove("active"));
      btn.classList.add("active");

      currentModel = btn.dataset.model;
      if (baseSkinImg) viewer.loadSkin(canvas.toDataURL("image/png"), { model: currentModel });
    });
  });

  // --- DOWNLOAD ---
  downloadBtn.addEventListener("click", () => {
    const a = document.createElement("a");
    a.href = canvas.toDataURL("image/png");
    a.download = "probending_skin.png";
    a.click();
  });

});
</script>

</body>
</html>
