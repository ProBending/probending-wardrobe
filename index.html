<script>
document.addEventListener("DOMContentLoaded", () => {
  console.log("Probending Wardrobe â€“ Base Outer-Layer Wipe Build Loaded");

  const canvas = document.getElementById("skinCanvas");
  const ctx = canvas.getContext("2d");

  const statusText = document.getElementById("statusText");
  const downloadBtn = document.getElementById("downloadBtn");

  const outfitButtons = [...document.querySelectorAll(".outfit-btn")];
  const modelButtons  = [...document.querySelectorAll(".toggle-btn")];

  const skin3dCanvas = document.getElementById("skin3d");

  let baseSkinImg = null;
  let outfitImg = null;
  let currentModel = "default";

  function setStatus(msg) {
    statusText.textContent = msg;
  }

  /* -------------------------------
     3D VIEWER
  --------------------------------*/
  const viewer = new skinview3d.SkinViewer({
    canvas: skin3dCanvas,
    width: 300,
    height: 380,
    zoom: 0.9
  });

  viewer.autoRotate = true;
  viewer.autoRotateSpeed = 0.6;

  // âŒ IMPORTANT: we DO NOT touch viewer.playerObject.skin.outerLayer here.
  // That was causing "Cannot set properties of undefined (setting 'visible')".


  /* -------------------------------
     Clear base skin's body/arms/legs OUTER LAYER
     (keep only head outer layer so hats etc still work)
  --------------------------------*/
  function clearBaseOuterLayers() {
    if (!canvas.width || !canvas.height) return;

    // Minecraft 64x64 UVs, bottom-half = outer layer:

    // Body outer layer (torso jacket)
    ctx.clearRect(16, 32, 24, 16); // x, y, w, h

    // Right arm outer layer (classic)
    ctx.clearRect(40, 32, 16, 16);

    // Left arm outer layer
    ctx.clearRect(32, 48, 16, 16);

    // Right leg outer layer
    ctx.clearRect(0, 32, 16, 16);

    // Left leg outer layer
    ctx.clearRect(16, 48, 16, 16);

    // NOTE: We intentionally do NOT clear the head outer layer (32,0,32x16)
    // so any hats / hair accessories stay visible.
  }


  /* -------------------------------
     LOAD 3D MODEL
  --------------------------------*/
  function update3D() {
    if (!baseSkinImg) return;
    viewer.loadSkin(canvas.toDataURL(), { model: currentModel });
  }


  /* -------------------------------
     RENDER FINAL SKIN
  --------------------------------*/
  function renderCanvas() {
    if (!baseSkinImg) return;

    canvas.width = baseSkinImg.width;
    canvas.height = baseSkinImg.height;

    ctx.clearRect(0, 0, canvas.width, canvas.height);

    // Draw the player's base skin
    ctx.drawImage(baseSkinImg, 0, 0);

    // ðŸ”¥ Wipe base skin's outer body/arms/legs
    clearBaseOuterLayers();

    // Then draw the probending outfit on top
    if (outfitImg) {
      ctx.drawImage(outfitImg, 0, 0);
    }

    update3D();
    downloadBtn.disabled = false;
    setStatus("Skin ready. Download when satisfied.");
  }


  /* LOAD FROM UPLOAD */
  document.getElementById("skinFile").addEventListener("change", e => {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = ev => {
      const img = new Image();
      img.onload = () => {
        baseSkinImg = img;
        renderCanvas();
      };
      img.src = ev.target.result;
    };
    reader.readAsDataURL(file);
  });


  /* LOAD FROM USERNAME */
  document.getElementById("loadUsernameBtn").addEventListener("click", () => {
    const name = document.getElementById("usernameInput").value.trim();
    if (!name) return;

    const img = new Image();
    img.crossOrigin = "anonymous";
    img.onload = () => {
      baseSkinImg = img;
      renderCanvas();
    };
    img.src = "https://minotar.net/skin/" + encodeURIComponent(name);
  });


  /* OUTFITS */
  outfitButtons.forEach(btn => {
    btn.addEventListener("click", () => {
      outfitButtons.forEach(b => b.classList.remove("active"));
      btn.classList.add("active");

      const img = new Image();
      img.onload = () => {
        outfitImg = img;
        renderCanvas();
      };
      img.src = btn.dataset.outfit;
    });
  });


  /* MODEL TOGGLE */
  modelButtons.forEach(btn => {
    btn.addEventListener("click", () => {
      modelButtons.forEach(b => b.classList.remove("active"));
      btn.classList.add("active");

      currentModel = btn.dataset.model;
      update3D();
    });
  });


  /* DOWNLOAD */
  downloadBtn.addEventListener("click", () => {
    const a = document.createElement("a");
    a.href = canvas.toDataURL("image/png");
    a.download = "probending_skin.png";
    a.click();
  });

});
</script>
