<script>
document.addEventListener("DOMContentLoaded", () => {
  console.log("Probending Wardrobe Script – SAFE v5 Loaded");

  const canvas = document.getElementById("skinCanvas");
  const ctx = canvas.getContext("2d");

  const skin3dCanvas = document.getElementById("skin3d");
  const statusText = document.getElementById("statusText");
  const downloadBtn = document.getElementById("downloadBtn");

  const skinFileInput = document.getElementById("skinFile");
  const usernameInput = document.getElementById("usernameInput");
  const loadUsernameBtn = document.getElementById("loadUsernameBtn");

  const outfitButtons = Array.from(document.querySelectorAll(".outfit-btn"));
  const modelButtons = Array.from(document.querySelectorAll(".pill-btn"));

  let baseSkinImg = null;
  let outfitImg = null;
  let currentModel = "default";

  function setStatus(msg) {
    statusText.textContent = msg;
  }

  // 3D Viewer
  const viewer = new skinview3d.SkinViewer({
    canvas: skin3dCanvas,
    width: 300,
    height: 360,
    zoom: 0.9
  });

  viewer.autoRotate = true;
  viewer.autoRotateSpeed = 0.6;

  function update3DPreview() {
    if (!baseSkinImg) return;

    let dataURL;
    try {
      dataURL = canvas.toDataURL();
    } catch (err) {
      console.error(err);
      setStatus("Security error – make sure you're using GitHub Pages URL, not a file:// link.");
      return;
    }

    const tempImg = new Image();
    tempImg.onload = () => {
      viewer.loadSkin(tempImg.src, {
        model: currentModel === "slim" ? "slim" : "default"
      });
    };
    tempImg.src = dataURL;
  }

  // ---- SAFE OUTER-LAYER REMOVAL ----
  // This clears ONLY the jacket/sleeves/pants overlays (correct vanilla positions)
  function clearOuterLayers() {
    // UPPER BODY OUTER LAYER (front, back, sides)
    ctx.clearRect(16, 36, 24, 12);  // torso outer
    // ARMS OUTER
    ctx.clearRect(40, 36, 8, 12);   // right arm outer
    ctx.clearRect(48, 36, 8, 12);   // left arm outer
    // LEGS OUTER
    ctx.clearRect(0, 36, 8, 12);    // right leg outer
    ctx.clearRect(8, 36, 8, 12);    // left leg outer

    // MIRRORED LOWER OUTER LAYER
    ctx.clearRect(16, 52, 24, 12);  // torso outer (bottom copy)
    ctx.clearRect(40, 52, 8, 12);
    ctx.clearRect(48, 52, 8, 12);
    ctx.clearRect(0, 52, 8, 12);
    ctx.clearRect(8, 52, 8, 12);
  }

  // ---- RENDER SKIN + OUTFIT ----
  function renderCanvas() {
    if (!baseSkinImg) {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      downloadBtn.disabled = true;
      setStatus("Load a skin to get started.");
      return;
    }

    canvas.width = baseSkinImg.width;
    canvas.height = baseSkinImg.height;

    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.drawImage(baseSkinImg, 0, 0);

    // REMOVE original outer clothing
    clearOuterLayers();

    if (outfitImg) {
      ctx.drawImage(outfitImg, 0, 0);
      setStatus("Skin + outfit ready.");
    } else {
      setStatus("Skin loaded. Select an outfit.");
    }

    downloadBtn.disabled = false;
    update3DPreview();
  }

  // ---- LOAD SKIN FILE ----
  skinFileInput.addEventListener("change", (e) => {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (ev) => {
      const img = new Image();
      img.onload = () => {
        baseSkinImg = img;
        renderCanvas();
      };
      img.src = ev.target.result;
    };
    reader.readAsDataURL(file);
  });

  // ---- LOAD SKIN BY USERNAME ----
  loadUsernameBtn.addEventListener("click", () => {
    const name = usernameInput.value.trim();
    if (!name) return;

    const img = new Image();
    img.crossOrigin = "anonymous";
    img.onload = () => {
      baseSkinImg = img;
      renderCanvas();
    };
    img.onerror = () => setStatus("Could not load username skin.");
    img.src = "https://minotar.net/skin/" + encodeURIComponent(name);
  });

  // ---- OUTFIT SELECTION ----
  outfitButtons.forEach(btn => {
    btn.addEventListener("click", () => {
      outfitButtons.forEach(b => b.classList.remove("active"));
      btn.classList.add("active");

      const path = btn.dataset.outfit;
      if (!path) {
        outfitImg = null;
        renderCanvas();
        return;
      }

      const img = new Image();
      img.onload = () => {
        outfitImg = img;
        renderCanvas();
      };
      img.src = path;
    });
  });

  // ---- MODEL TOGGLE ----
  modelButtons.forEach(btn => {
    btn.addEventListener("click", () => {
      modelButtons.forEach(b => b.classList.remove("active"));
      btn.classList.add("active");

      currentModel = btn.dataset.model;
      update3DPreview();
    });
  });

  // ---- DOWNLOAD ----
  downloadBtn.addEventListener("click", () => {
    if (!baseSkinImg) return;

    let url;
    try {
      url = canvas.toDataURL("image/png");
    } catch (err) {
      console.error(err);
      setStatus("Security error – you must use the GitHub Pages URL.");
      return;
    }

    const a = document.createElement("a");
    a.href = url;
    a.download = "probending_skin.png";
    a.click();
  });

  renderCanvas();
});
</script>
