<script>
  // Run after DOM is ready
  document.addEventListener("DOMContentLoaded", () => {
    console.log("Probending Wardrobe Script v4 Loaded");

    // ====== DOM ELEMENTS ======
    const canvas = document.getElementById("skinCanvas"); // hidden 2D canvas
    const ctx = canvas.getContext("2d");

    const statusText = document.getElementById("statusText");
    const downloadBtn = document.getElementById("downloadBtn");

    const skinFileInput = document.getElementById("skinFile");
    const usernameInput = document.getElementById("usernameInput");
    const loadUsernameBtn = document.getElementById("loadUsernameBtn");

    const outfitButtons = Array.from(document.querySelectorAll(".outfit-btn"));
    const modelButtons = Array.from(document.querySelectorAll(".pill-btn"));

    const skin3dCanvas = document.getElementById("skin3d");

    // ====== STATE ======
    let baseSkinImg = null;
    let outfitImg = null;
    let currentModel = "default"; // "default" (Steve) or "slim" (Alex)

    function setStatus(msg) {
      statusText.textContent = msg;
    }

    // ====== 3D VIEWER SETUP ======
    const viewer = new skinview3d.SkinViewer({
      canvas: skin3dCanvas,
      width: 300,
      height: 360,
      zoom: 0.9
    });

    // auto 360Â° spin
    viewer.autoRotate = true;
    viewer.autoRotateSpeed = 0.6;

    // ====== UPDATE 3D MODEL ======
    function update3DPreview() {
      if (!baseSkinImg) return;

      let dataUrl;
      try {
        dataUrl = canvas.toDataURL();
      } catch (e) {
        console.error(e);
        setStatus("Browser blocked preview (security). Make sure you're using the GitHub Pages URL, not file://");
        return;
      }

      const combinedImg = new Image();
      combinedImg.onload = () => {
        viewer.loadSkin(combinedImg.src, {
          model: currentModel === "slim" ? "slim" : "default"
        });
      };

      combinedImg.src = dataUrl;
    }

    // ====== DRAW ON 2D CANVAS (wipe second layer below head) ======
    function renderCanvas() {
      if (!baseSkinImg) {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        setStatus("Load a skin to get started.");
        downloadBtn.disabled = true;
        return;
      }

      // Resize canvas to match skin
      canvas.width = baseSkinImg.width;
      canvas.height = baseSkinImg.height;

      ctx.clearRect(0, 0, canvas.width, canvas.height);

      // 1) Draw base skin
      ctx.drawImage(baseSkinImg, 0, 0, canvas.width, canvas.height);

      // 2) Wipe lower half (y >= 32) to remove all body/arms/legs overlays
      //    In 64x64 format, the **outer clothing + extra limb textures**
      //    live in the bottom 32px. We keep the head layers (y < 32).
      ctx.clearRect(0, 32, canvas.width, canvas.height - 32);

      // 3) Draw probending outfit overlay on top
      if (outfitImg) {
        ctx.drawImage(outfitImg, 0, 0, canvas.width, canvas.height);
        setStatus("Skin + outfit ready. Click download to save.");
      } else {
        setStatus("Skin loaded. Select an outfit or download as-is.");
      }

      downloadBtn.disabled = false;

      // 4) Update the 3D preview
      update3DPreview();
    }

    // ====== LOAD SKIN FROM FILE ======
    function loadSkinFromFile(file) {
      if (!file) return;

      const reader = new FileReader();

      reader.onload = (e) => {
        const img = new Image();
        img.onload = () => {
          baseSkinImg = img;
          renderCanvas();
        };
        img.onerror = () => setStatus("Could not read that skin file.");
        img.src = e.target.result;
      };

      reader.readAsDataURL(file);
      setStatus("Loading skin from file...");
    }

    // ====== LOAD SKIN FROM USERNAME ======
    function loadSkinFromUsername(username) {
      if (!username) return;

      const img = new Image();
      img.crossOrigin = "anonymous";

      img.onload = () => {
        baseSkinImg = img;
        renderCanvas();
      };

      img.onerror = () => setStatus("Could not load skin for that username.");

      img.src = "https://minotar.net/skin/" + encodeURIComponent(username.trim());

      setStatus("Fetching skin for " + username + "...");
    }

    // ====== LOAD OUTFIT OVERLAY ======
    function loadOutfit(path) {
      if (!path) {
        outfitImg = null;
        renderCanvas();
        return;
      }

      const img = new Image();
      img.onload = () => {
        outfitImg = img;
        renderCanvas();
      };
      img.onerror = () => setStatus("Could not load outfit image: " + path);
      img.src = path;

      setStatus("Loading outfit...");
    }

    // ====== EVENT LISTENERS ======

    // Upload skin file
    skinFileInput.addEventListener("change", (e) => {
      const file = e.target.files[0];
      loadSkinFromFile(file);
    });

    // Username search
    loadUsernameBtn.addEventListener("click", () => {
      const username = usernameInput.value.trim();
      if (!username) {
        setStatus("Enter a username first.");
        return;
      }
      loadSkinFromUsername(username);
    });

    usernameInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        loadUsernameBtn.click();
      }
    });

    // Outfit selection
    outfitButtons.forEach((btn) => {
      btn.addEventListener("click", () => {
        outfitButtons.forEach((b) => b.classList.remove("active"));
        btn.classList.add("active");

        const outfitPath = btn.dataset.outfit || "";
        loadOutfit(outfitPath);
      });
    });

    // Model toggle (Steve / Slim)
    modelButtons.forEach((btn) => {
      btn.addEventListener("click", () => {
        modelButtons.forEach((b) => b.classList.remove("active"));
        btn.classList.add("active");

        currentModel = btn.dataset.model === "slim" ? "slim" : "default";
        update3DPreview();
      });
    });

    // Download final PNG
    downloadBtn.addEventListener("click", () => {
      if (!baseSkinImg) return;

      let dataUrl;
      try {
        dataUrl = canvas.toDataURL("image/png");
      } catch (e) {
        console.error(e);
        setStatus("Browser blocked download (security). Make sure you're using the GitHub Pages URL, not file://");
        return;
      }

      const link = document.createElement("a");
      link.download = "probending_skin.png";
      link.href = dataUrl;

      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    });

    // ====== INITIAL ======
    renderCanvas();
  });
</script>
